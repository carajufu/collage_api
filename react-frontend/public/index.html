<!-- 프로젝트 루트\react-frontend\public\index.html -->

<script>
/*
  [브릿지 스크립트 설명]

  1) 코드 의도
      - Spring Security 세션 기반 관리자 로그인 결과를 React SPA JWT 환경으로 넘기는 최종 브릿지임.
      - AdminExchangeController 가 '/app#accessToken=...' 형태로 리다이렉트한 URL에서 해시 값을 회수해 localStorage 에 저장한 뒤, URL 에서 토큰 흔적을 제거함.

  2) 데이터 흐름 (입력 → 가공 → 출력)
      - 입력
        - location.hash
          예시: '#accessToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
      - 가공
        - URLSearchParams 로 accessToken 쿼리 파라미터 추출
        - localStorage.setItem("accessToken", 토큰) 으로 브라우저 저장소에 기록
      - 출력
        - 저장소 출력: localStorage["accessToken"] 에 JWT 문자열 영속 보관
        - URL 출력: history.replaceState 로 '#accessToken=...' 이 제거된 '/app' 또는 '/app?쿼리' 상태로 변경

  3) 계약 (전제, 성공 조건, 에러 처리)
      - 전제 조건
        - AdminExchangeController 가 target 으로 '/app#accessToken=...' 같은 URL 을 내려보낸다.
        - React 앱의 인증 로직은 localStorage["accessToken"] 을 읽어 Authorization 헤더를 구성한다.
      - 성공 조건
        - URL 해시에 accessToken 이 존재할 때
          1) localStorage["accessToken"] 에 토큰이 정상적으로 저장되고
          2) 주소창에서 '#accessToken=...' 이 제거된다.
      - 에러 및 예외 처리
        - location.hash 가 비어 있거나, accessToken 파라미터가 없으면 아무 동작 없이 종료한다.
        - localStorage 저장 중 예외가 발생해도 try catch 로 삼키고, 애플리케이션 크래시를 막는다.
          단, 이 경우 JWT 저장에 실패하므로 이후 API 인증은 실패할 수 있음.

  4) 파라미터 명세
      - location.hash
        - 타입: string
        - 의미: 현재 URL 의 해시 부분 전체 (예: '#accessToken=...')
        - 필수 여부: 선택 (없으면 스크립트는 바로 종료)
        - 허용 값: 빈 문자열 또는 accessToken 쿼리 파라미터를 포함한 문자열
      - accessToken (쿼리 파라미터 이름)
        - 타입: string (JWT 토큰)
        - 의미: TokenService 가 발급한 Access Token
        - 필수 여부: 선택 (없으면 스크립트는 어떤 상태도 변경하지 않음)
        - 예시 값: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        - 저장 위치: localStorage["accessToken"]
        - 사용 용도: React axios 인스턴스 등에서 Authorization 헤더 값 구성
          예: 'Bearer ' + localStorage.getItem("accessToken")
      - localStorage
        - 타입: Web Storage API (브라우저 별도 제공 키 값 저장소)
        - 제약: 브라우저 설정, 시크릿 모드, 용량 제한으로 인해 setItem 이 실패할 수 있음

  5) 보안 및 안전 전제
      - 네트워크 구간
        - HTTPS 환경을 전제로 한다. JWT 가 URL 해시와 localStorage 사이를 이동할 때 네트워크 구간은 TLS 로 보호되어야 함.
      - 토큰 노출 최소화
        - accessToken 은 잠시 URL 해시에 노출되지만, 이 스크립트가 즉시 localStorage 로 옮기고 history.replaceState 로 주소창에서 제거해 노출 시간을 최소화함.
      - XSS 관련
        - JWT 를 localStorage 에 저장하는 것은 XSS 공격에 취약하므로,
          전체 프론트엔드에서는
            - Content Security Policy 를 강하게 설정하고
            - innerHTML 사용 최소화, 외부 스크립트 삽입 금지 등 기본적인 XSS 방어가 필수임.
      - 비유: 해시는 일회용 전달봉, localStorage 는 그 이후에 계속 들고 다니는 카드라고 보면 됨. 전달이 끝나면 전달봉(해시)은 바로 버린다.

  6) 유지보수자 가이드
      - 실행 시점
        - 이 스크립트는 React 번들이 실행되기 전에 한 번만 동작해야 하므로, public/index.html 의 head 나 body 상단에 유지해야 함.
      - 키 이름 변경 시 주의
        - localStorage 키 이름("accessToken") 을 변경하면,
          React 쪽의 axios 인터셉터, 인증 훅, 컨텍스트 등에서 참조하는 키 이름도 함께 변경해야 한다.
      - URL 포맷 변경 시 주의
        - 만약 '#accessToken=...' 이 아니라 '?accessToken=...' 같은 쿼리스트링 방식으로 바꾸려면,
          location.hash 대신 location.search 를 읽는 별도 로직이 필요하며,
          동시에 AdminExchangeController 의 target URL 포맷도 함께 수정해야 함.

  7) 근거
      - 사용 API
        - Window.location, URLSearchParams, Web Storage API(localStorage), History API(history.replaceState) 같은 표준 브라우저 API 에만 의존함.
      - 프론트엔드 기준
        - 프로젝트 기준 React 19.1.1, ReactDOM 19.1.1, React Router DOM 7.9.4 환경에서,
          public/index.html 이 SPA 부팅 전에 한 번 로드된다는 전제를 둠.
*/

(function () {
  // URL 에 해시('#...')가 없으면 아무 동작 없이 종료
  if (!location.hash) return;

  // '#accessToken=...' 문자열에서 앞의 '#' 을 제거하고, 쿼리 파라미터 형식으로 파싱
  const params = new URLSearchParams(location.hash.slice(1));

  // 해시 파라미터 중 'accessToken' 값을 추출 (JWT 토큰 문자열)
  const t = params.get("accessToken");

  // accessToken 이 없으면 이 스크립트는 아무 것도 하지 않고 종료
  if (!t) return;

  try {
    // 추출한 JWT 를 브라우저 localStorage 에 저장
    // 계약: 이후 React 앱은 이 값을 읽어 Authorization 헤더를 구성함
    localStorage.setItem("accessToken", t);
  } catch (_) {
    // localStorage 사용 불가 시 (프라이빗 모드, 용량 초과 등)
    // 에러를 노출하지 않고 무시하여 앱 초기 부팅이 크래시 나지 않도록 방어
    // 단, 이 경우 인증이 필요한 요청은 모두 실패할 수 있음
  }

  // 주소창에서 '#accessToken=...' 해시 부분을 제거하고,
  // 같은 경로와 쿼리스트링만 남긴 채 히스토리를 교체 (페이지 리로드 없음)
  history.replaceState(null, "", location.pathname + location.search);
})();
</script>

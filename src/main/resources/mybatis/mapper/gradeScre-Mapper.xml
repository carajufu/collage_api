<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.ac.collage_api.grade.mapper.GradeScreMapper">

<!--/////////////////////// 교수용 ///////////////////////-->		

    <!-- 1) 교수가 맡은 개설교과목 목록 -->
    <select id="getAllSbject" resultType="kr.ac.collage_api.grade.vo.GradeScreVO">
        SELECT
            ESTBLLCTRE_CODE, LCTRE_CODE, PROFSR_NO, FILE_GROUP_NO, ACQS_PNT
            , LCTRUM, COMPL_SE, ATNLC_NMPR, LCTRE_USE_LANG, EVL_MTHD
            , ATEND_SCORE_REFLCT_RATE, TASK_SCORE_REFLCT_RATE, MIDDLE_TEST_SCORE_REFLCT_RATE, TRMEND_TEST_SCORE_REFLCT_RATE
            , ESTBL_YEAR, ESTBL_SEMSTR
        FROM ESTBL_COURSE
        WHERE PROFSR_NO = #{profsrNo}
    </select>

    <!-- 2) 강의 기본 정보 -->
    <select id="getCourse" resultType="kr.ac.collage_api.grade.vo.GradeScreVO">
        SELECT
            A.LCTRE_CODE, A.SUBJCT_CODE, A.PRE_LECTURE, A.LCTRE_NM, A.OPER_AT, A.RECENT_UPDT_DT
            ,B.ESTBLLCTRE_CODE
        FROM ALL_COURSE A
        JOIN ESTBL_COURSE B ON A.LCTRE_CODE = B.LCTRE_CODE
        WHERE B.PROFSR_NO = #{profsrNo}
    </select>

    <!-- 3) 해당 강의 수강 학생 & 성적 -->
    <select id="getSbjectScr" resultType="kr.ac.collage_api.grade.vo.GradeScreVO">
		SELECT 
		    E.STDNT_NO as stdntNo, E.STDNT_NM as stdntNm, AC.LCTRE_NM, C.PROFSR_NO
		    ,D.YEAR, D.SEMSTR
		    ,A.ATEND_SCORE, A.TASK_SCORE, A.MIDDLE_SCORE, A.TRMEND_SCORE
		    ,A.SBJECT_TOTPOINT, A.PNT_GRAD, A.AVRG_SCORE
		    ,B.ATNLC_REQST_NO as atnlcReqstNo
		FROM ATNLC_REQST B
		JOIN ESTBL_COURSE C ON B.ESTBLLCTRE_CODE = C.ESTBLLCTRE_CODE
		JOIN ALL_COURSE AC ON C.LCTRE_CODE = AC.LCTRE_CODE
		JOIN SEMSTR_SCRE D ON B.STDNT_NO = D.STDNT_NO
		JOIN STDNT E ON D.STDNT_NO = E.STDNT_NO
		LEFT JOIN SBJECT_SCRE A ON B.ATNLC_REQST_NO = A.ATNLC_REQST_NO 
		WHERE C.ESTBLLCTRE_CODE = #{estbllctreCode}
		ORDER BY E.STDNT_NO
    </select>

    <!-- 4) 성적 수정 (기존 학생만 수정) -->
	<update id="updateGrades">
BEGIN
    <foreach collection="list" item="g" separator=";">
        UPDATE SBJECT_SCRE
        SET ATEND_SCORE = #{g.atendScore},
            TASK_SCORE = #{g.taskScore},
            MIDDLE_SCORE = #{g.middleScore},
            TRMEND_SCORE = #{g.trmendScore},
            SBJECT_TOTPOINT = #{g.sbjectTotpoint},
            PNT_GRAD = #{g.pntGrad},
            AVRG_SCORE = #{g.pntAvrg}
        WHERE ATNLC_REQST_NO = #{g.atnlcReqstNo}
    </foreach>;
END;
	</update>

    <!-- 5) 성적 저장 (없는 학생은 INSERT → 전체 UPDATE) -->
	<update id="saveGrades">
BEGIN
    INSERT INTO SBJECT_SCRE (ATNLC_REQST_NO, ATEND_SCORE, TASK_SCORE, MIDDLE_SCORE, TRMEND_SCORE, SBJECT_TOTPOINT, PNT_GRAD, AVRG_SCORE)
    SELECT A.ATNLC_REQST_NO, 0, 0, 0, 0, 0, 'F', 0
    FROM ATNLC_REQST A
    WHERE A.ESTBLLCTRE_CODE = #{estbllctreCode}
    AND NOT EXISTS (
        SELECT 1 FROM SBJECT_SCRE B WHERE B.ATNLC_REQST_NO = A.ATNLC_REQST_NO
    );

    <foreach collection="list" item="g" separator=";">
        UPDATE SBJECT_SCRE
        SET ATEND_SCORE = #{g.atendScore},
            TASK_SCORE = #{g.taskScore},
            MIDDLE_SCORE = #{g.middleScore},
            TRMEND_SCORE = #{g.trmendScore},
            SBJECT_TOTPOINT = #{g.sbjectTotpoint},
            PNT_GRAD = #{g.pntGrad},
            AVRG_SCORE = #{g.pntAvrg}
        WHERE ATNLC_REQST_NO = #{g.atnlcReqstNo}
    </foreach>;
END;
	</update>

<!--/////////////////////// 학생용 ///////////////////////-->	

  <!-- 학생용 학기별 성적 목록 -->
<!-- <select id="getAllScore" resultType="kr.ac.collage_api.grade.vo.GradeVO"> -->
<!-- 	SELECT -->
<!-- 	    A.SEMSTR_SCRE_INNB, A.STDNT_NO, A.TOT_REQST_PNT, A.TOT_ACQS_PNT, -->
<!-- 	    A.PNT_AVRG, A.SEMSTR, A.YEAR, A.SEMSTR_TOTPOINT, -->
<!-- 	    B.SBJECT_SCRE_INNB, B.SEMSTR_SCRE_INNB, B.ATNLC_REQST_NO, B.PNT_GRAD, B.ACQS_PNT, -->
<!-- 	    B.ATEND_SCORE, B.TASK_SCORE, B.MIDDLE_SCORE, B.TRMEND_SCORE, B.SBJECT_TOTPOINT, B.AVRG_SCORE, -->
<!-- 	    C.ESTBLLCTRE_CODE, AC.LCTRE_NM -->
<!-- 	FROM SEMSTR_SCRE A -->
<!-- 	JOIN SBJECT_SCRE B ON A.SEMSTR_SCRE_INNB = B.SEMSTR_SCRE_INNB -->
<!-- 	JOIN ATNLC_REQST C ON B.ATNLC_REQST_NO = C.ATNLC_REQST_NO -->
<!-- 	JOIN ESTBL_COURSE EC ON C.ESTBLLCTRE_CODE = EC.ESTBLLCTRE_CODE -->
<!-- 	JOIN ALL_COURSE AC ON EC.LCTRE_CODE = AC.LCTRE_CODE -->
<!-- 	WHERE A.STDNT_NO = #{stdntNo} -->
<!-- </select> -->
  
  <!-- 학생용 과목별 성적 목록 -->
<select id="getAllSemstr" resultType="kr.ac.collage_api.grade.vo.GradeScreVO">
SELECT
    A.LCTRE_NM, B.ACQS_PNT, B.ESTBL_YEAR, B.ESTBL_SEMSTR
    ,B.PROFSR_NO, C.STDNT_NO, C.ATNLC_REQST_NO, D.SBJECT_SCRE_INNB
    ,D.SEMSTR_SCRE_INNB, D.PNT_GRAD, D.ATEND_SCORE, D.TASK_SCORE
    ,D.MIDDLE_SCORE, D.TRMEND_SCORE, D.SBJECT_TOTPOINT, D.AVRG_SCORE
    ,E.SEMSTR, E.YEAR
FROM ALL_COURSE A
JOIN ESTBL_COURSE B
      ON A.LCTRE_CODE = B.LCTRE_CODE
JOIN ATNLC_REQST C
      ON B.ESTBLLCTRE_CODE = C.ESTBLLCTRE_CODE
JOIN SBJECT_SCRE D
      ON C.ATNLC_REQST_NO = D.ATNLC_REQST_NO
JOIN SEMSTR_SCRE E
	  ON D.SEMSTR_SCRE_INNB = E.SEMSTR_SCRE_INNB
WHERE C.STDNT_NO = #{stdntNo}
</select>

    <!-- 학생용 과목 상세 성적 -->
<!--     <select id="getSbjectDetailScore" parameterType="map" resultType="kr.ac.collage_api.grade.vo.GradeVO"> -->
<!--         SELECT -->
<!--             AC.LCTRE_NM AS lctreNm, -->
<!--             C.ESTBLLCTRE_CODE AS estbllctreCode, -->
<!--             A.ATEND_SCORE AS atendScore, -->
<!--             A.TASK_SCORE AS taskScore, -->
<!--             A.MIDDLE_SCORE AS middleScore, -->
<!--             A.TRMEND_SCORE AS trmendScore, -->
<!--             A.SBJECT_TOTPOINT AS sbjectTotpoint, -->
<!--             A.AVRG_SCORE AS avrgScore, -->
<!--             A.PNT_GRAD AS pntGrad -->
<!--         FROM SBJECT_SCRE A -->
<!--         JOIN ATNLC_REQST B ON A.ATNLC_REQST_NO = B.ATNLC_REQST_NO -->
<!--         JOIN ESTBL_COURSE C ON B.ESTBLLCTRE_CODE = C.ESTBLLCTRE_CODE -->
<!--         JOIN ALL_COURSE AC ON C.LCTRE_CODE = AC.LCTRE_CODE -->
<!--         WHERE B.STDNT_NO = #{stdntNo} -->
<!--         AND C.ESTBLLCTRE_CODE = #{estbllctreCode} -->
<!--     </select> -->

</mapper>

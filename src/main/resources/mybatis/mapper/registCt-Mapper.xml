<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="kr.ac.collage_api.regist.mapper.RegistCtMapper">

	<!-- 등록금 고지 등록 -->
	<insert id="insertRegist" parameterType="RegistCtVO">
		<selectKey keyProperty="registCtNo" resultType="int"
			order="BEFORE">
			SELECT REGIST_CT_SEQ.NEXTVAL FROM DUAL
		</selectKey>

		INSERT INTO REGIST_CT (
		REGIST_CT_NO,
		SUBJCT_CODE,
		RQEST_YEAR,
		RQEST_SEMSTR,
		RQEST_UNIV,
		RQEST_GRADE,
		RQEST_GLD,
		RQEST_DE,
		PAY_ENDDE
		)
		VALUES (
		#{registCtNo},
		#{subjctCode},
		#{rqestYear},
		#{rqestSemstr},
		#{rqestUniv},
		#{rqestGrade},
		#{rqestGld},
		SYSDATE,
		#{payEndde}
		)
	</insert>

	<!-- 중복 체크 -->
	<select id="checkDuplicateRegist" parameterType="RegistCtVO"
		resultType="int">
		SELECT
		COUNT(*)
		FROM REGIST_CT
		WHERE RQEST_YEAR = #{rqestYear}
		AND RQEST_SEMSTR
		= #{rqestSemstr}
		AND SUBJCT_CODE = #{subjctCode}
		AND
		RQEST_GRADE =
		#{rqestGrade}
	</select>

	<!-- 등록금 고지 목록 조회 -->
	<select id="selectRegistList" resultType="RegistCtVO">
		SELECT
		R.REGIST_CT_NO AS
		registCtNo,
		R.SUBJCT_CODE AS
		subjctCode,
		S.SUBJCT_NM AS subjctName,
		U.UNIV_NM AS univName,
		R.RQEST_YEAR AS rqestYear,
		R.RQEST_SEMSTR AS
		rqestSemstr,
		R.RQEST_UNIV
		AS rqestUniv,
		R.RQEST_GRADE
		AS rqestGrade,
		R.RQEST_GLD AS rqestGld,
		R.RQEST_DE AS rqestDe,
		R.PAY_ENDDE AS payEndde
		FROM REGIST_CT R
		JOIN
		SUBJCT S ON R.SUBJCT_CODE
		= S.SUBJCT_CODE
		JOIN UNIV
		U ON R.RQEST_UNIV = U.UNIV_CODE
		ORDER BY R.RQEST_YEAR DESC,
		R.RQEST_SEMSTR DESC,
		R.RQEST_UNIV,
		R.RQEST_GRADE
	</select>

	<!-- 학과코드 + 학년으로 재학생 조회 -->
	<select id="selectStudentsByDeptAndGrade" resultType="StdntVO">
		SELECT
		S.STDNT_NO AS stdntNo,
		S.STDNT_NM AS stdntNm,
		S.SUBJCT_CODE AS
		subjctCode,
		S.GRADE AS grade
		FROM STDNT S
		WHERE TRIM(S.SUBJCT_CODE) =
		TRIM(#{subjctCode})
		AND TO_CHAR(S.GRADE) = TO_CHAR(#{rqestGrade})
		AND
		TRIM(S.SKNRGS_STTUS) = '재학'
	</select>


	<!-- 단과대 목록 -->
	<select id="selectUnivList" resultType="map">
		SELECT UNIV_CODE AS
		univCode, UNIV_NM AS univNm
		FROM UNIV
		ORDER BY UNIV_NM
	</select>

	<!-- 단과대별 학과 목록 -->
	<select id="selectSubjectsByUniv"
		parameterType="java.lang.String" resultType="map">
		SELECT S.SUBJCT_CODE AS
		subjctCode, S.SUBJCT_NM AS subjctName
		FROM SUBJCT S
		WHERE S.UNIV_CODE =
		#{univCode}
		ORDER BY S.SUBJCT_NM
	</select>

	<select id="selectUnissuedSubjects" parameterType="map"
		resultType="map">
		SELECT
		U.UNIV_CODE AS univCode,
		U.UNIV_NM AS univNm,
		S.SUBJCT_CODE AS
		subjctCode,
		S.SUBJCT_NM AS subjctNm,
		G.grade AS grade
		FROM SUBJCT S
		JOIN
		UNIV U ON S.UNIV_CODE = U.UNIV_CODE
		CROSS JOIN (
		SELECT '1' AS grade
		FROM dual
		UNION ALL SELECT '2' FROM dual
		UNION ALL SELECT '3' FROM dual
		UNION ALL SELECT '4' FROM dual
		) G
        WHERE 1 = 1

        <!-- 단과대 필터 -->
		<if test="rqestUniv != null and rqestUniv != ''">
			AND U.UNIV_CODE = #{rqestUniv}
		</if>

        <!-- 학과 필터 -->
        <if test="subjctCode != null and subjctCode != ''">
            AND S.SUBJCT_CODE = #{subjctCode}
        </if>

        <!-- 학년 필터 -->
		<if test="rqestGrade != null and rqestGrade != ''">
			AND G.grade = #{rqestGrade}
		</if>
        AND NOT EXISTS (
        SELECT 1
        FROM REGIST_CT R
        WHERE R.SUBJCT_CODE =
        S.SUBJCT_CODE
        AND R.RQEST_GRADE = G.grade

        <if test="rqestYear != null and rqestYear != ''">
            AND R.RQEST_YEAR = #{rqestYear}
        </if>

        <if test="rqestSemstr != null and rqestSemstr != ''">
            AND R.RQEST_SEMSTR = #{rqestSemstr}
        </if>
        )


        <!-- 연도/학기만 선택한 경우 -->
        <if test="rqestYear != null and rqestYear != ''">
            AND (
            SELECT COUNT(1)
            FROM REGIST_CT R2
            WHERE R2.SUBJCT_CODE
            = S.SUBJCT_CODE
            AND R2.RQEST_YEAR = #{rqestYear}
            AND R2.RQEST_SEMSTR =
            #{rqestSemstr}
            ) = 0
        </if>
		ORDER BY U.UNIV_CODE, S.SUBJCT_NM, G.grade
	</select>



	<!-- 등록금 수정 -->
	<update id="updateRegistCt" parameterType="registCtVO">
		UPDATE REGIST_CT
		SET
		RQEST_YEAR = #{rqestYear},
		RQEST_SEMSTR = #{rqestSemstr},
		RQEST_GLD =
		#{rqestGld},
		PAY_ENDDE = #{payEndde}
		WHERE REGIST_CT_NO = #{registCtNo}
	</update>


	<!-- 등록금 삭제 -->
	<delete id="deleteRegistCt" parameterType="int">
		DELETE FROM REGIST_CT
		WHERE REGIST_CT_NO = #{registCtNo}
	</delete>


</mapper>

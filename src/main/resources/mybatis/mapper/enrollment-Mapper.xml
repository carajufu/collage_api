<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.collage_api.enrollment.mapper.EnrollmentMapper">

<<<<<<< HEAD
	<resultMap id="stdntSubjectMap" type="kr.ac.collage_api.vo.StdntVO" autoMapping="true">
		<id property="stdntNo" column="STDNT_NO" />
		
		<association property="subjctVO" javaType="kr.ac.collage_api.vo.SubjctVO">
			<result property="subjctNm" column="SUBJCT_NM" />
		</association>
	</resultMap>

	<!-- 학생정보 -->
	<select id="selectStdnt" parameterType="String" resultMap="stdntSubjectMap">
	    SELECT
	        S.STDNT_NO
	        ,S.STDNT_NM
	        ,S.SKNRGS_STTUS
	        ,S.GRADE
	        ,S.SUBJCT_CODE
	        ,B.SUBJCT_NM  
	        , S.ENTSCH_DE   
	    FROM
	        STDNT S 
	        LEFT JOIN SUBJCT B ON S.SUBJCT_CODE = B.SUBJCT_CODE
	    WHERE
	        S.STDNT_NO = #{stdntNo}
	</select>
	
	<!-- 학적변동내역 -->
	<select id="selectAllHistoryList" parameterType="String" resultType="kr.ac.collage_api.vo.SknrgsChangeReqstVO">
		SELECT 
			EFECT_OCCRRNC_SEMSTR
			, CHANGE_TY
			, CHANGE_REQST_DT
		FROM
			SKNRGS_CHANGE_REQST
		WHERE
			STDNT_NO = #{stdntNo} 
			AND REQST_STTUS = '승인'
		ORDER BY EFECT_OCCRRNC_SEMSTR DESC
			
	</select>
	
	<!-- 신청내역 -->
	<select id="selectHistoryList" parameterType="String" resultType="kr.ac.collage_api.vo.SknrgsChangeReqstVO">
		SELECT  
			EFECT_OCCRRNC_SEMSTR
			, REQST_STTUS
			, CHANGE_REQST_DT
			, REQST_RESN
			, RETURN_RESN
			, CHANGE_TY
			, TMPABSSKL_TY
		FROM
			SKNRGS_CHANGE_REQST
		WHERE
			STDNT_NO = #{stdntNo} 
		ORDER BY EFECT_OCCRRNC_SEMSTR DESC
	</select>
	
	<!-- 제출 -->
	<insert id="submitRequest" parameterType="kr.ac.collage_api.vo.SknrgsChangeReqstVO">
		INSERT INTO SKNRGS_CHANGE_REQST (
        	SKNRGS_CHANGE_INNB
        	, STDNT_NO
        	, CHANGE_TY
        	, EFECT_OCCRRNC_SEMSTR
        	, TMPABSSKL_TY
        	, REQST_RESN
        	, CHANGE_REQST_DT
        	, REQST_STTUS
        	, FILE_GROUP_NO )
        	
    	VALUES (
        	SKNRGS_CHANGE_REQST_SEQ.NEXTVAL
        	, #{stdntNo}
        	, #{changeTy}
        	, #{efectOccrrncSemstr}
        	, #{tmpabssklTy}
        	, #{reqstResn}
        	, SYSDATE
        	, '신청' 
        	, #{fileGroupNo} )
	</insert>
	
	<!-- ///////////////////////////관리자//////////////////////////////// -->	
	
	<resultMap id="requestStdntMap" type="kr.ac.collage_api.vo.SknrgsChangeReqstVO" autoMapping="true">
		<id property="skngsChangeInnb" column="requestStdntMap" />
		
		<association property="stdntVO" javaType="kr.ac.collage_api.vo.StdntVO">
			<result property="stdntNm" column="STDNT_NM" />
			<result property="fileNm" column="FILE_NM"/>
		</association>
	</resultMap>
	
	<!-- 학적변동 신청 목록 조회 -->
	<select id="getAllRequests" resultMap="requestStdntMap">
		SELECT
	        A.SKNRGS_CHANGE_INNB
	        ,A.STDNT_NO
	        ,A.CHANGE_TY
	        ,A.EFECT_OCCRRNC_SEMSTR
	        ,A.REQST_RESN
	        ,A.CHANGE_REQST_DT
	        ,A.REQST_STTUS
	        ,A.CONFM_COMPT_DT
	        ,A.RETURN_RESN
	        ,A.TMPABSSKL_TY
	        ,A.FILE_GROUP_NO
	        ,B.STDNT_NM  
        FROM
        	SKNRGS_CHANGE_REQST A
        	LEFT JOIN STDNT B ON A.STDNT_NO = B.STDNT_NO
	    ORDER BY
	        A.CHANGE_REQST_DT DESC
	</select>

	<!-- 상세조회 -->
	<select id="getRequestDetail" resultMap="requestStdntMap">
		SELECT
	        A.SKNRGS_CHANGE_INNB
	        ,A.STDNT_NO
	        ,A.CHANGE_TY
	        ,A.EFECT_OCCRRNC_SEMSTR
	        ,A.REQST_RESN
	        ,A.CHANGE_REQST_DT
	        ,A.REQST_STTUS
	        ,A.CONFM_COMPT_DT
	        ,A.RETURN_RESN
	        ,A.TMPABSSKL_TY
	        ,A.FILE_GROUP_NO
	        ,B.STDNT_NM 
	        ,C.FILE_NM 
	    FROM
	        SKNRGS_CHANGE_REQST A
	        LEFT JOIN STDNT B ON A.STDNT_NO = B.STDNT_NO
	        LEFT JOIN FILE_DETAIL C ON A.FILE_GROUP_NO = C.FILE_GROUP_NO
	    WHERE
	        A.SKNRGS_CHANGE_INNB = #{reqId}
	</select>
	
	<!-- 상태 업데이트 -->
	<update id="updateStatusOnly">
		UPDATE SKNRGS_CHANGE_REQST
	    SET 
	        REQST_STTUS = #{reqstSttus}
	        ,RETURN_RESN = #{returnResn}
	        ,CONFM_COMPT_DT = #{confmComptDt}
	        ,LAST_UPDT_TM = #{lastUpdtTm}
	    WHERE 
	    	SKNRGS_CHANGE_INNB = #{reqId}
	</update>
	
	<!-- 학적 상태 변경 -->
	<update id="changeStdntStatus">
		UPDATE STDNT
		SET SKNRGS_STTUS = #{newStatus}
		WHERE STDNT_NO = #{stdntNo}
	</update>
	
	<!-- 학적 이력 저장 -->
	<insert id="insertHistory" parameterType="kr.ac.collage_api.vo.SknrgsChangeHistVO">
		INSERT INTO SKNRGS_CHANGE_HIST (
	        SKNRGS_HIST_INNB
	        ,SKNRGS_CHANGE_INNB
	        ,CHANGE_DE
	        ,SKNRGS
	        ,CHANGE_RESN
	    ) VALUES (
	        SKNRGS_HIST_SEQ.NEXTVAL
	        ,#{sknrgsChangeInnb}
	        ,SYSDATE
	        ,#{sknrgs}
	        ,#{changeResn}
	    )
	</insert>
	
	
=======
>>>>>>> 26a4290 (please)
</mapper>
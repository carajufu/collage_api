<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.ac.collage_api.mapper.CertDocxRequestMapper">

    <!--
        블록: resultMap (CrtfIssuRequestMap)

        1) 코드 의도
           - 증명서 발급 요청서 CRTF_ISSU_REQUEST 행과 증명서 종류 마스터 CRTF_KND 행을 한 번에 VO로 적재
           - CrtfIssuRequestVO 안에 CrtfKndVO까지 association으로 넣어줌
           - 프런트는 코드값 'ENROLL' 대신 사람이 읽는 이름 '재학증명서'를 바로 쓸 수 있음

        2) 데이터 흐름
           - 입력  : JOIN SELECT 결과 (요청 R + 마스터 K)
           - 가공  : 기본 필드는 CrtfIssuRequestVO에 직접 매핑
                     증명서 마스터 필드는 CrtfIssuRequestVO.crtfKnd (CrtfKndVO)로 중첩 매핑
           - 출력  : CrtfIssuRequestVO 또는 그 리스트

        3) 계약
           - CrtfIssuRequestVO 필드명은
             crtfIssuInnb, crtfKndNo, fileGroupNo, stdntNo, reqstDt, issuDt, issuSttus, crtfKnd
             로 정의돼 있어야 함
           - 내부 association 대상 VO는 kr.ac.collage_api.vo.CrtfKndVO 여야 함
           - reqstDt, issuDt는 LocalDateTime 변환이 가능해야 함
             MyBatis가 Oracle TIMESTAMP → java.time.LocalDateTime 변환 가능한 typeHandler를 이미 가지고 있지 않으면 직접 handler 필요

        4) 보안·안전 전제
           - 이 VO에는 학생 식별자 STDNT_NO 포함
             즉 PII. 마이페이지 본인 조회 목적 외 외부 노출 금지라는 전제 필요
           - 단순 마스터 데이터(crtfNm 등)는 민감도가 낮지만 STDNT_NO는 민감하므로 컨트롤러에서 본인 검증 필수

        5) 유지보수자 가이드
           - REQST_DT ISSU_DT 컬럼명이나 타입이 바뀌면 타임스탬프 변환 로직부터 전부 깨진다
           - ISSU_STTUS 철자 그대로 사용 중 (STATUS 아님). 임의로 바꾸지 말 것
           - CRTF_ISSU_REQUEST 테이블명이 과거 설계안에서 CRTF_ISSU_REQUST로 쓰인 적 있음
             철자 혼용은 DBA와 반드시 정합해야 한다. 오라클에 실제로 존재하는 테이블명을 따라야 한다
    -->
    <resultMap id="CrtfIssuRequestMap" type="kr.ac.collage_api.vo.CrtfIssuRequestVO">

        <!--
            crtfIssuInnb
            1) 코드 의도
               - 발급 요청 PK. 추적 키
            2) 데이터 흐름
               - INSERT에서 selectKey로 생성. 이후 전체 흐름의 식별자
            3) 계약
               - null 불허라고 가정
            4) 보안·안전
               - 이 값으로 단일 요청 상세를 조회하므로 감사 추적 키가 됨
            5) 유지보수
               - 포맷 CERTYYYYMMDD#### 로 묶여 있음. 포맷 변경은 레거시 로그 재조회에 영향 크므로 사전 합의 필수
        -->
        <id     property="crtfIssuInnb" column="CRTF_ISSU_INNB"/>

        <!--
            crtfKndNo
            1) 코드 의도
               - 어떤 종류의 증명서를 요청했는지 (예 ENROLL GRADE GRAD 등)
            2) 데이터 흐름
               - insertIssueRequest 에서 그대로 INSERT
               - association.crtfKnd.crtfKndNo 도 같은 값 사용
            3) 계약
               - FK. 반드시 CRTF_KND.CRTF_KND_NO 에 존재해야 함
            4) 보안
               - 민감 아님
            5) 유지보수
               - FK 무결성 깨지면 발급 불가로 처리해야 함
        -->
        <result property="crtfKndNo"    column="CRTF_KND_NO"/>

        <!--
            fileGroupNo
            1) 코드 의도
               - 발급된 증명서 산출물 파일 묶음 번호. 파일 업로드/다운로드 묶음 키
            2) 데이터 흐름
               - insertIssueRequest 시 #{fileGroupNo} 로 들어감
            3) 계약
               - NUMBER 계열이면 VO는 Long 또는 BigDecimal이어야 함
               - mapper에는 jdbcType=BIGINT로 들어가는데 Oracle에는 BIGINT 타입이 없고 NUMBER로 매핑하므로 불일치 가능성 있음. 위험구간
            4) 보안
               - 파일 경로 추적 키라서 외부 직접 노출 시 파일 접근 통제 검증 필요
            5) 유지보수
               - 파일 스토리지 테이블과 동시 관리 대상. 단독으로 바꾸면 파일 링크 끊김
        -->
        <result property="fileGroupNo"  column="FILE_GROUP_NO"/>

        <!--
            stdntNo
            1) 코드 의도
               - 요청자 학생 학번
            2) 데이터 흐름
               - 마이페이지 자기 이력 조회 조건으로 사용
            3) 계약
               - 로그인한 사용자와 동일해야 함. 권한 체크 없으면 타인 이력 조회 가능해져서 보안 사고
            4) 보안
               - 민감 식별자임. 컨트롤러에서 세션/토큰의 acntId 또는 stdntNo와 반드시 비교해야 함
            5) 유지보수
               - 학번 체계 바뀌어도 컬럼명 STDNT_NO 유지하면 상위 계층 영향 최소화
        -->
        <result property="stdntNo"      column="STDNT_NO"/>

        <!--
            reqstDt
            1) 코드 의도
               - 발급 시도 시간
            2) 데이터 흐름
               - insertIssueRequest 에서 SYSTIMESTAMP 로 채워짐
            3) 계약
               - LocalDateTime 매핑 가정. MyBatis에 적절한 typeHandler 없으면 변환 실패 가능
               - null 불허라고 보는 게 정상. 요청 로그에 시간은 반드시 남아야 감사 가능
            4) 보안
               - 타임라인 증거. 감사 추적용
            5) 유지보수
               - 컬럼명 바뀌면 모든 이력 조회 정렬 (ORDER BY REQST_DT DESC) 깨짐
        -->
        <result property="reqstDt"      column="REQST_DT"    javaType="java.time.LocalDateTime"/>

        <!--
            issuDt
            1) 코드 의도
               - 실제 발급이 완료된 시각
            2) 데이터 흐름
               - markIssued 호출 시 UPDATE로 설정
            3) 계약
               - DONE 상태에서만 값 존재
               - REQUESTED 상태에서는 null 가능
            4) 보안
               - 언제 발급됐는지 증거로 쓰임. 위변조 불가해야 함
            5) 유지보수
               - 컬럼을 NULL 허용으로 유지할 것. REQUESTED 단계에서는 아직 발급 전이라 비어 있어야 정상
        -->
        <result property="issuDt"       column="ISSU_DT"     javaType="java.time.LocalDateTime"/>

        <!--
            issuSttus
            1) 코드 의도
               - 발급 상태값. REQUESTED 또는 DONE 등
            2) 데이터 흐름
               - insertIssueRequest 에서 'REQUESTED'로 저장
               - markIssued 에서 DONE 으로 전환
            3) 계약
               - 임의 문자열로 바꾸지 말고 사전에 합의된 ENUM 성격 값만 사용해야 함
            4) 보안
               - 상태 전이 시 이력 관리 필요. DONE 이후에 다시 덮어쓰지 못하게 markIssued에서 방어
            5) 유지보수
               - 컬럼명 ISSU_STTUS 오탈자처럼 보이나 고정 자산임. STATUS로 리팩토링하면 기존 로그와 불일치. 주의
        -->
        <result property="issuSttus"    column="ISSU_STTUS"/>

        <!--
            association: crtfKnd
            1) 코드 의도
               - 현재 요청 레코드에 연결된 증명서 마스터 정보를 중첩 VO로 묶음
            2) 데이터 흐름
               - SELECT JOIN 결과의 K.* 컬럼들을 CrtfKndVO 필드에 채움
            3) 계약
               - CrtfKndVO 필드명은 crtfKndNo crtfNm crtfDc issuFee crtfIssuForm 이어야 한다
               - issuFee 타입 BigDecimal vs Long 등 숫자 타입 호환 필수
            4) 보안
               - 이 블록 자체는 민감 정보 아님. 수수료와 템플릿 코드 수준
            5) 유지보수
               - 이 association을 없애면 프런트는 별도 추가 쿼리로 마스터를 또 조회해야 하므로 N+1 문제 발생 가능
        -->
        <association property="crtfKnd" javaType="kr.ac.collage_api.vo.CrtfKndVO">
            <result property="crtfKndNo"    column="CRTF_KND_NO"/>
            <result property="crtfNm"       column="CRTF_NM"/>
            <result property="crtfDc"       column="CRTF_DC"/>
            <result property="issuFee"      column="ISSU_FEE"/>
            <result property="crtfIssuForm" column="CRTF_ISSU_FORM"/>
        </association>
    </resultMap>

    <!--
        블록: insertIssueRequest

        1) 코드 의도
           - 학생이 증명서 발급을 요청한 순간을 DB에 남김
           - 상태는 항상 'REQUESTED'로 시작
           - REQST_DT 는 시스템 시각으로 자동 기록
           - ISSU_DT 는 아직 null

        2) 데이터 흐름
           - 입력  : CrtfIssuRequestVO (crtfKndNo, fileGroupNo, stdntNo 등)
           - 가공  : selectKey가 먼저 PK(crtfIssuInnb)를 생성
                     이후 INSERT 실행
           - 출력  : DB에는 새로운 요청 행 1건 생성
                     VO.crtfIssuInnb 에 생성된 PK 값이 세팅됨

        3) 계약
           - selectKey
             'CERT' + YYYYMMDD + 시퀀스 4자리 패턴 유지
             CERT_ISSU_REQ_SEQ 시퀀스 존재 필수
           - fileGroupNo 는 NULL 가능 설계인지 여부 확인 필요
             현재 #{fileGroupNo,jdbcType=BIGINT} 로 바인딩 중
             Oracle 환경에서는 NUMBER로 들어가야 할 가능성 있음
           - STDNT_NO 등 필수값은 NOT NULL 제약이어야 한다
             그렇지 않으면 감사 추적 불가

        4) 보안·안전 전제
           - 이 INSERT는 행정 감사 근거가 된다
           - 누가 언제 어떤 증명서를 요구했는지 로그를 영구적으로 남긴다
           - 삭제나 UPDATE로 이력을 덮으면 안 된다
             delete 금지 정책이 필요하다
           - SYSTIMESTAMP 사용. 호출자가 시간을 조작할 수 없다

        5) 유지보수자 가이드
           - 테이블명 CRTF_ISSU_REQUEST 정식 확정 필요
             과거 명세 CRTF_ISSU_REQUST 와 혼용되면 배포 환경에서 ORA-00942 테이블 없음 발생
           - CERT_ISSU_REQ_SEQ 명칭도 DBA와 고정해야 한다
             이름 바뀌면 PK 생성 로직 전부 깨짐
    -->
    <insert id="insertIssueRequest" parameterType="kr.ac.collage_api.vo.CrtfIssuRequestVO">

        <selectKey keyProperty="crtfIssuInnb"
                   resultType="string"
                   order="BEFORE">
            SELECT 'CERT' ||
                   TO_CHAR(SYSDATE,'YYYYMMDD') ||
                   LPAD(CERT_ISSU_REQ_SEQ.NEXTVAL,4,'0')
            FROM DUAL
        </selectKey>

        INSERT INTO CRTF_ISSU_REQUEST (
            CRTF_ISSU_INNB,
            CRTF_KND_NO,
            FILE_GROUP_NO,
            STDNT_NO,
            REQST_DT,
            ISSU_DT,
            ISSU_STTUS
        ) VALUES (
            #{crtfIssuInnb},
            #{crtfKndNo},
            #{fileGroupNo,jdbcType=BIGINT},
            #{stdntNo},
            SYSTIMESTAMP,
            NULL,
            'REQUESTED'
        )
    </insert>

    <!--
        블록: markIssued

        1) 코드 의도
           - 실제 증명서 파일(PDF 등) 생성과 저장이 끝난 순간 상태를 DONE 으로 바꿈
           - ISSU_DT 타임스탬프를 확정 기록

        2) 데이터 흐름
           - 입력  : crtfIssuInnb, issuDt, issuSttusBefore
           - 가공  : UPDATE ... WHERE CRTF_ISSU_INNB = pk AND ISSU_STTUS = 이전상태
           - 출력  : UPDATE된 row 수 (0 또는 1). 0이면 실패

        3) 계약
           - WHERE ISSU_STTUS = #{issuSttusBefore}
             즉 낙관적 잠금 역할
             이미 DONE 처리된 요청에 중복 발급 완료를 덮어쓰지 못하게 막는다
           - issuDt 는 컨트롤러에서 java.time.LocalDateTime 또는 java.sql.Timestamp 로 넣어야 하며
             jdbcType=TIMESTAMP 와 호환돼야 한다

        4) 보안·안전 전제
           - row count 0 은 비정상 상황 신호로 간주해야 한다
             예) 동일 발급 건을 2번 마킹하려는 재시도
           - DONE 이후 다시 REQUESTED 로 되돌리는 경로는 의도적으로 없음
             발급 이력은 불변 로그여야 하기 때문

        5) 유지보수자 가이드
           - ISSU_STTUS 값 집합 (REQUESTED, DONE 등)을 ENUM으로 관리하지 않으면 오타 위험
           - markIssued 를 호출할 권한은 내부 발급 프로세스 한정이어야 한다
             사용자가 직접 호출하면 위변조 가능
    -->
    <update id="markIssued">
        UPDATE CRTF_ISSU_REQUEST
        SET
            ISSU_STTUS = 'DONE',
            ISSU_DT    = #{issuDt,jdbcType=TIMESTAMP}
        WHERE
            CRTF_ISSU_INNB = #{crtfIssuInnb}
          AND ISSU_STTUS   = #{issuSttusBefore}
    </update>

    <!--
        블록: selectByInnb

        1) 코드 의도
           - 단일 발급 요청 상세 확인
           - 관리자나 감사자가 "이건 누구에게 언제 어떤 증명서를 줬나"를 복원할 때 사용

        2) 데이터 흐름
           - 입력  : crtfIssuInnb (요청 PK)
           - 가공  : CRTF_ISSU_REQUEST R 과 CRTF_KND K 조인
           - 출력  : CrtfIssuRequestVO (CrtfIssuRequestMap)

        3) 계약
           - PK 기반 단일 조회. 결과 없으면 null
           - TEAM1_202505F 스키마 prefix가 여기에만 붙어있고 다른 쿼리에는 없음
             배포 환경에서 스키마를 전부 붙일지 전부 생략할지 통일해야 함

        4) 보안·안전 전제
           - STDNT_NO 노출. 접근자는 관리자 또는 본인으로 제한돼야 한다
           - 마스터 정보(K.CRTF_ISSU_FORM 등)는 템플릿 코드라 민감도 낮음
           - 이 쿼리는 과거 기록을 읽을 뿐이라서 DB 변경은 없음

        5) 유지보수자 가이드
           - SELECT 절은 화이트리스트 방식으로 유지할 것
             새로운 내부 감사용 컬럼이 테이블에 생겨도 자동 노출되지 않도록 하기 위함
           - 스키마 prefix 통일 안 하면 로컬과 운영에서 각각 다른 동작이 발생 가능
    -->
    <select id="selectByInnb"
            parameterType="string"
            resultMap="CrtfIssuRequestMap">
        SELECT
            R.CRTF_ISSU_INNB,
            R.CRTF_KND_NO,
            R.FILE_GROUP_NO,
            R.STDNT_NO,
            R.REQST_DT,
            R.ISSU_DT,
            R.ISSU_STTUS,
            K.CRTF_NM,
            K.CRTF_DC,
            K.ISSU_FEE,
            K.CRTF_ISSU_FORM
        FROM TEAM1_202505F.CRTF_ISSU_REQUEST R
        JOIN TEAM1_202505F.CRTF_KND K
          ON R.CRTF_KND_NO = K.CRTF_KND_NO
        WHERE R.CRTF_ISSU_INNB = #{crtfIssuInnb}
    </select>

    <!--
        블록: selectListByStdntNo

        1) 코드 의도
           - 학생 마이페이지에서 "내 증명서 발급 이력" 보여주기
           - REQUESTED 상태 요청도 같이 보여주므로 학생은 처리 상태를 즉시 볼 수 있다

        2) 데이터 흐름
           - 입력  : stdntNo
           - 가공  : 특정 학생 STDNT_NO 로 필터 후 JOIN해서 증명서명 등까지 가져옴
           - 출력  : List<CrtfIssuRequestVO>

        3) 계약
           - WHERE R.STDNT_NO = #{stdntNo} 로 제한
             즉 다른 학번을 넣으면 그 사람 이력까지 볼 수 있으므로 컨트롤러단에서
             로그인 사용자와 파라미터 stdntNo 가 동일한지 체크가 반드시 필요
           - ORDER BY R.REQST_DT DESC 로 최신 요청이 위로 온다

        4) 보안·안전 전제
           - 이 쿼리는 민감한 개인 이력이다
             세션 또는 JWT 기반으로 본인 외 호출을 차단해야 한다
           - 관리자 화면에서 전체 학생 이력을 보려면 별도의 어드민 전용 쿼리를 분리하는 게 안전하다
             일반 쿼리에 관리자 모드 옵션을 억지로 넣으면 권한 우회 위험이 생긴다

        5) 유지보수자 가이드
           - 여기서는 스키마 prefix가 없다
             위 selectByInnb 와 다르다. 환경에 따라 ORA-00942 가능
             운영 배포 전 통일 필수
           - ORDER BY 기준을 바꾸면 UI에서 "최근 요청 먼저" 가 깨진다
             프런트와 합의 없이 바꾸지 말 것
    -->
    <select id="selectListByStdntNo"
            parameterType="string"
            resultMap="CrtfIssuRequestMap">
        SELECT
            R.CRTF_ISSU_INNB,
            R.CRTF_KND_NO,
            R.FILE_GROUP_NO,
            R.STDNT_NO,
            R.REQST_DT,
            R.ISSU_DT,
            R.ISSU_STTUS,
            K.CRTF_NM,
            K.CRTF_DC,
            K.ISSU_FEE,
            K.CRTF_ISSU_FORM
        FROM CRTF_ISSU_REQUEST R
        JOIN CRTF_KND K
          ON R.CRTF_KND_NO = K.CRTF_KND_NO
        WHERE R.STDNT_NO = #{stdntNo}
        ORDER BY R.REQST_DT DESC
    </select>

</mapper>

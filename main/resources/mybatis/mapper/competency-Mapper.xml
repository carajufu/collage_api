<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.ac.collage_api.competency.mapper.CompetencyMapper">

    <!-- 다음 FORM_ID 구하기 -->
    <select id="getNextFormNo" resultType="int">
        SELECT NVL(MAX(FORM_ID), 0) + 1
        FROM COMPETENCY
    </select>

    <!-- 기본 이력 1건 조회 (항상 최신 FORM_ID 1건) -->
    <select id="getFormData" resultType="kr.ac.collage_api.competency.vo.CompetencyVO">
        SELECT
             FORM_ID
            ,STDNT_NO
            ,LAST_ACDMCR
            ,MILTR_AT
            ,DESIRE_JOB
            ,CRQFC
            ,EDC_HISTORY
            ,MAIN_PROJECT
            ,CHARACTER
            ,MANAGE_CN
        FROM COMPETENCY
        WHERE STDNT_NO = #{stdntNo}
        ORDER BY FORM_ID DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 기본폼 + 자소서 버전 전체 조회 (관리용) -->
    <select id="getAllByStdntNo" resultType="kr.ac.collage_api.competency.vo.CompetencyVO">
        SELECT
             FORM_ID
            ,STDNT_NO
            ,LAST_ACDMCR
            ,MILTR_AT
            ,DESIRE_JOB
            ,CRQFC
            ,EDC_HISTORY
            ,MAIN_PROJECT
            ,CHARACTER
            ,MANAGE_CN
        FROM COMPETENCY
        WHERE STDNT_NO = #{stdntNo}
        ORDER BY FORM_ID DESC
    </select>

    <!-- 기본 정보 INSERT -->
    <insert id="insertFormData">
        INSERT INTO COMPETENCY (
             FORM_ID
            ,STDNT_NO
            ,LAST_ACDMCR
            ,MILTR_AT
            ,DESIRE_JOB
            ,CRQFC
            ,EDC_HISTORY
            ,MAIN_PROJECT
            ,CHARACTER
        ) VALUES (
             #{formId}
            ,#{stdntNo}
            ,#{lastAcdmcr}
            ,#{miltrAt}
            ,#{desireJob}
            ,#{crqfc}
            ,#{edcHistory}
            ,#{mainProject}
            ,#{character}
        )
    </insert>

    <!-- 기본 정보 UPDATE (항상 최신 FORM_ID 1건 갱신) -->
    <update id="updateFormData">
        UPDATE COMPETENCY
        SET LAST_ACDMCR = #{lastAcdmcr}
           ,MILTR_AT    = #{miltrAt}
           ,DESIRE_JOB  = #{desireJob}
           ,CRQFC       = #{crqfc}
           ,EDC_HISTORY = #{edcHistory}
           ,MAIN_PROJECT= #{mainProject}
           ,CHARACTER   = #{character}
        WHERE FORM_ID  = #{formId}
          AND STDNT_NO = #{stdntNo}
    </update>

    <!-- AI 자소서 버전 INSERT -->
    <insert id="insertManageCn">
        INSERT INTO COMPETENCY (
             FORM_ID
            ,STDNT_NO
            ,LAST_ACDMCR
            ,MILTR_AT
            ,DESIRE_JOB
            ,CRQFC
            ,EDC_HISTORY
            ,MAIN_PROJECT
            ,CHARACTER
            ,MANAGE_CN
        ) VALUES (
             #{formId}
            ,#{stdntNo}
            ,#{lastAcdmcr}
            ,#{miltrAt}
            ,#{desireJob}
            ,#{crqfc}
            ,#{edcHistory}
            ,#{mainProject}
            ,#{character}
            ,#{manageCn}
        )
    </insert>

    <!-- 전체 자소서 버전 목록 -->
    <select id="getManageCnList" resultType="kr.ac.collage_api.competency.vo.CompetencyVO">
        SELECT
             FORM_ID
            ,STDNT_NO
            ,MANAGE_CN
        FROM COMPETENCY
        WHERE STDNT_NO = #{stdntNo}
          AND MANAGE_CN IS NOT NULL
    </select>

    <!-- 자소서 단일 버전 삭제 -->
	<delete id="deleteManageCnOne">
	    DELETE FROM COMPETENCY
	    WHERE STDNT_NO = #{stdntNo}
	      AND FORM_ID  = #{formId}
	      AND MANAGE_CN IS NOT NULL
	</delete>

</mapper>
